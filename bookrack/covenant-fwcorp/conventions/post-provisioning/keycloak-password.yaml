# Post-Provisioning: Keycloak Initial Password via REST API
# Sets temporary password with requiredActions: UPDATE_PASSWORD
#
# Flow:
# 1. Generate random initial password
# 2. Set password in Keycloak via REST API
# 3. Configure requiredActions to force password change on first login
# 4. Save initial password to Secret (shared with stalwart-email)
# 5. User must change password on first Keycloak login

# Enable this post-provisioning action
enabled: true

# Conditions: All users get Keycloak password
conditions:
  roles:
    - user
    - full

# Container configuration
container:
  name: keycloak-password-provisioner
  image:
    name: alpine/curl
    tag: latest
  command:
    - /bin/sh
    - -c
  args:
    - |
      set -e  # Exit on error

      echo "=== Keycloak Password Provisioning (REST API) ==="
      echo "User: {{ .username }}"
      echo "Email: {{ .email }}"

      # Step 0: Install dependencies
      echo "‚Üí Installing dependencies..."
      apk add --no-cache jq > /dev/null 2>&1
      echo "‚úì Dependencies installed"

      # Step 1: Generate initial password for Keycloak
      # Must comply with password policy: length>=12, 1 uppercase, 1 lowercase, 1 digit, 1 special char
      KC_INITIAL_PASSWORD="KeycloakInit${RANDOM}${RANDOM}!Pass"
      echo "‚úì Keycloak initial password generated"

      # Step 2: Authenticate to Keycloak as admin
      echo "‚Üí Authenticating to Keycloak..."

      KC_TOKEN_RESPONSE=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -d "username=$KEYCLOAK_ADMIN_USER" \
        -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
        -d "grant_type=password" \
        -d "client_id=admin-cli")

      KC_ACCESS_TOKEN=$(echo "$KC_TOKEN_RESPONSE" | jq -r '.access_token')

      if [ "$KC_ACCESS_TOKEN" = "null" ] || [ -z "$KC_ACCESS_TOKEN" ]; then
        echo "‚úó Failed to authenticate to Keycloak"
        echo "Response: $KC_TOKEN_RESPONSE"
        exit 1
      fi
      echo "‚úì Authenticated to Keycloak"

      # Step 3: Find user ID in Keycloak
      echo "‚Üí Finding user in Keycloak..."

      USER_RESPONSE=$(curl -s -X GET "$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/users?username={{ .username }}" \
        -H "Authorization: Bearer $KC_ACCESS_TOKEN")

      USER_ID=$(echo "$USER_RESPONSE" | jq -r '.[0].id')

      if [ "$USER_ID" = "null" ] || [ -z "$USER_ID" ]; then
        echo "‚úó User not found in Keycloak: {{ .username }}"
        echo "Response: $USER_RESPONSE"
        exit 1
      fi
      echo "‚úì User found (ID: $USER_ID)"

      # Step 4: Set initial password with temporary flag
      echo "‚Üí Setting initial password in Keycloak..."

      PASSWORD_SET_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/users/$USER_ID/reset-password" \
        -H "Authorization: Bearer $KC_ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"type\": \"password\",
          \"value\": \"$KC_INITIAL_PASSWORD\",
          \"temporary\": true
        }")

      PASSWORD_HTTP_CODE=$(echo "$PASSWORD_SET_RESPONSE" | tail -n1)

      if [ "$PASSWORD_HTTP_CODE" = "204" ]; then
        echo "‚úì Initial password set in Keycloak (temporary)"
      else
        echo "‚úó Failed to set password (HTTP $PASSWORD_HTTP_CODE)"
        echo "Response: $PASSWORD_SET_RESPONSE"
        exit 1
      fi

      # Step 5: Configure requiredActions (force password change on first login)
      echo "‚Üí Configuring required actions..."

      ACTIONS_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$KEYCLOAK_URL/admin/realms/$KEYCLOAK_REALM/users/$USER_ID" \
        -H "Authorization: Bearer $KC_ACCESS_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"requiredActions\": [\"UPDATE_PASSWORD\"]
        }")

      ACTIONS_HTTP_CODE=$(echo "$ACTIONS_RESPONSE" | tail -n1)

      if [ "$ACTIONS_HTTP_CODE" = "204" ]; then
        echo "‚úì Required actions configured (UPDATE_PASSWORD)"
      else
        echo "‚úó Failed to set required actions (HTTP $ACTIONS_HTTP_CODE)"
        echo "Response: $ACTIONS_RESPONSE"
        exit 1
      fi

      # Step 6: Save initial password to Kubernetes Secret (via K8s API)
      # This secret is shared with stalwart-email post-provisioning
      # If secret exists, patch it; if not, create it
      echo "‚Üí Saving/updating initial password in Secret..."

      # Extract local part of username (before @) for Secret name and label
      SECRET_NAME_SUFFIX=$(echo "{{ .username }}" | cut -d'@' -f1)
      USERNAME_LABEL=$(echo "{{ .username }}" | sed 's/[@.]/-/g')

      # Encode password to base64
      KC_PASSWORD_B64=$(echo -n "$KC_INITIAL_PASSWORD" | base64 | tr -d '\n')

      # Get ServiceAccount token for K8s API auth
      SA_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
      K8S_API="https://kubernetes.default.svc"

      # Try to get existing secret first
      EXISTING_SECRET=$(curl -s -X GET "$K8S_API/api/v1/namespaces/keycloak/secrets/covenant-initial-password-$SECRET_NAME_SUFFIX" \
        -H "Authorization: Bearer $SA_TOKEN" \
        --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)

      SECRET_EXISTS=$(echo "$EXISTING_SECRET" | jq -r '.kind')

      if [ "$SECRET_EXISTS" = "Secret" ]; then
        echo "‚ö† Secret exists, patching with Keycloak password..."

        # Patch existing secret to add keycloak-password key
        PATCH_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH "$K8S_API/api/v1/namespaces/keycloak/secrets/covenant-initial-password-$SECRET_NAME_SUFFIX" \
          -H "Authorization: Bearer $SA_TOKEN" \
          -H "Content-Type: application/strategic-merge-patch+json" \
          --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
          -d "{
            \"data\": {
              \"keycloak-password\": \"$KC_PASSWORD_B64\"
            }
          }")

        PATCH_HTTP_CODE=$(echo "$PATCH_RESPONSE" | tail -n1)

        if [ "$PATCH_HTTP_CODE" = "200" ]; then
          echo "‚úì Secret patched with Keycloak password"
        else
          echo "‚úó Failed to patch Secret (HTTP $PATCH_HTTP_CODE)"
          echo "Response: $PATCH_RESPONSE"
          exit 1
        fi
      else
        echo "‚Üí Secret doesn't exist, creating with Keycloak password..."

        # Create new secret with keycloak-password key
        SECRET_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$K8S_API/api/v1/namespaces/keycloak/secrets" \
          -H "Authorization: Bearer $SA_TOKEN" \
          -H "Content-Type: application/json" \
          --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
          -d "{
            \"apiVersion\": \"v1\",
            \"kind\": \"Secret\",
            \"metadata\": {
              \"name\": \"covenant-initial-password-$SECRET_NAME_SUFFIX\",
              \"labels\": {
                \"covenant.kast.ing/type\": \"initial-password\",
                \"covenant.kast.ing/user\": \"$USERNAME_LABEL\"
              }
            },
            \"type\": \"Opaque\",
            \"data\": {
              \"keycloak-password\": \"$KC_PASSWORD_B64\"
            }
          }")

        SECRET_HTTP_CODE=$(echo "$SECRET_RESPONSE" | tail -n1)

        if [ "$SECRET_HTTP_CODE" = "201" ]; then
          echo "‚úì Secret created with Keycloak password"
        else
          echo "‚úó Failed to create Secret (HTTP $SECRET_HTTP_CODE)"
          echo "Response: $SECRET_RESPONSE"
          exit 1
        fi
      fi

      # Step 7: Clear sensitive data from memory
      unset KC_INITIAL_PASSWORD
      unset KC_ACCESS_TOKEN
      unset KC_PASSWORD_B64

      echo "=== Provisioning complete ==="
      echo "‚úÖ Keycloak password: Set (temporary, requires change on first login)"
      echo "‚úÖ Required actions: UPDATE_PASSWORD"
      echo "‚úÖ Password stored in Secret: covenant-initial-password-$SECRET_NAME_SUFFIX"
      echo ""
      echo "üìß User will receive email with initial password"
      echo "‚ö†Ô∏è  User MUST change password on first Keycloak login"
      echo ""
      echo "üìù Admin: Retrieve initial password with:"
      echo "   kubectl get secret -n keycloak covenant-initial-password-$SECRET_NAME_SUFFIX -o jsonpath='{.data.keycloak-password}' | base64 -d"

  env:
    # Keycloak admin credentials for REST API authentication
    - name: KEYCLOAK_ADMIN_USER
      valueFrom:
        secretKeyRef:
          name: keycloak-access
          key: username
    - name: KEYCLOAK_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-access
          key: password

  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Job configuration
job:
  # Backoff limit for retries
  backoffLimit: 3
  # Timeout in seconds
  activeDeadlineSeconds: 300
  # Restart policy
  restartPolicy: OnFailure
